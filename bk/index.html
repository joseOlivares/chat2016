<!doctype html>
<html>
  <head>
  	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<meta name="description" content="">
	<meta name="author" content="">


	<!-- <script src="libs/js/jquery.js" type="text/javascript"></script>  -->
	<link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
	<script src="/js/bootstrap.min.js" type="text/javascript"></script>  
 	<script src="/js/jlfunctions.js" type="text/javascript"></script> 
	<!-- <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>  -->


   	<link href="/css/style.css" rel="stylesheet" type="text/css">

   <title>Chat 1.0,by Luis Olivares</title>
 <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
 <script src="http://code.jquery.com/jquery-1.11.1.js"></script>

<script>
	$( document ).ready(function() {
  //-------------------------------------------	
	      var socket = io(); //creating socket connection
	      var usericon='<span class="glyphicon glyphicon-user blue"></span> ';
	      var currentUser='nobody';//current user nickname 

    // Loading stored messages from this current chat user
	    socket.on('initial msgs', function(data){
	    	alert('Cargando datos...');
	    	//alert(data[0][12].msg); //mensaje del registro numero 13
	        for (var i = 0; i < data[0].length; i++){
	 			$('#messages').append('<li class="list-group-item">' + usericon +' '+data[0][i].nickname+': </br>'+data[0][i].msg + '    ' + '		'+data[0][i].datetime + '</li>');
	        }
	 	    
	        if(data[0].length>0){ //si existe al menos un mensaje guardado del usuario actual
	 	    	currentUser=data[0][0].nickname; // saving nickname of currect user
	 	    }else{
	 	    	currentUser='No registered'; //saving some value for current user
	 	    }

	 	    $('#txtChat').scrollTop($('#txtChat')[0].scrollHeight);//moving to the last msg  
	 	    
		    $('#m').focus(); //set focus to input 	         
	    }); 


		$('#btnLogin').on('click',function(){
			var loginId=$('#idsender').val();//id current logged user
			$('#idsender').prop('disabled', true);
			socket.emit('user logged',loginId); //enviando ID de usurio logeado
		})

		socket.on('user logged',function(myInfo){//receives current user data, this is an array
			currentUser=myInfo[0].nickname;
		});


		//Form Submitt  Event	
	      $('form').submit(function(){ //sending data 

	      	var arraymsg=[$('#idsender').val(),$('#idreceiver').val(),$('#m').val()];
	      	socket.emit('chat message', arraymsg); //envindo mensaje a node
	        //socket.emit('chat message', $('#m').val()); //emitiendo mensaje a node
	        $('#m').val('');
	        return false;
	      });
	     //---------------------------------------------------

	     
	      socket.on('chat message', function(msg){ //recive informacion ingresda en chat
	      	if(msg==''){
	      		return false; //if msg is empty, do nothing
	      	}
	        
	      	var timenow=getDateTime(); //getting time from personal function in jlfunctions.js
 			$('#messages').append('<li class="list-group-item">' + usericon +' '+currentUser+':</br>'+msg[2] + '    ' + msg[3] + '</li>');

	        $('#txtChat').scrollTop($('#txtChat')[0].scrollHeight);//moving to the last msg

	        $('#m').focus(); //set focus to input
	      });

   
    socket.on('users connected', function(data){
        $('#usersConnected').html(data); //displaying how many conncetions are.
    });    




 //-------------------------------------------- 		
});
</script>
  </head>
  <body>
  <div class="container">
  	<div class="row">
  	<div class="col-xs-12 col-sm-12 col-md-12"> 
		<div class="panel panel-primary">
		  <!-- Default panel contents -->
		  <div class="panel-heading">Welcome to our Chat,  Users Connected: <span class="badge" id="usersConnected"></span>
				<br>
				<div class="form-inline">  	<input class="form-control input-sm" id="idsender" />
				  	<button id="btnLogin" class="btn btn-default">Login</button></div>
		  </div>

		  <div class="panel-body chatbody" id="txtChat">
				  <ul class="list-group " id="messages"> </ul> <!-- chat messages here -->
		  </div>
		  	<div class="panel-footer"> 
				    <form action="" class="form-inline">
				      <input id="m" autocomplete="off" class="form-control input-sm" /><button class="btn btn-default">Send</button>
				      
				     <!-- <label>From Id<input id="idsender" class="form-control input-xs"/></label> -->
				      <label>To Id<input id="idreceiver" class="form-control input-xs"/></label>

				    </form>
		  	</div>
		</div>
	</div> <!-- end col -->
	</div>	<!-- End row -->

   </div> <!-- End container-->

    <script>

    </script>
  </body>
</html>
